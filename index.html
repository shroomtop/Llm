<!DOCTYPE html>
<html lang="en" data-theme="dark">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Shroomtop420™ No-API Chatbot</title>

  <!-- CSP / hardening -->
  <meta http-equiv="Content-Security-Policy"
        content="default-src 'self' https://cdn.jsdelivr.net https://esm.run;
                 style-src  'self' https://cdn.jsdelivr.net 'unsafe-inline';
                 script-src 'self' https://cdn.jsdelivr.net https://esm.run 'unsafe-inline';
                 img-src 'self' data:;
                 connect-src *;
                 upgrade-insecure-requests;">

  <!-- Tailwind Play CDN -->
  <script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"></script>

  <style>
    /* graceful-fallback helpers */
    [x-cloak]{display:none}
    /* top progress bar */
    #dlBar{transition:width .2s}
  </style>

  <!-- Embedded meta-files (LICENSE.txt, README.txt, VERSION.txt, manifest.json, promptmeta.json) -->
  <!-- …(exact same content as previous version, omitted here for brevity)… -->
</head>
<body class="min-h-screen flex flex-col bg-slate-900 text-slate-100 antialiased">

  <!-- progress bar -->
  <div id="dlBar" class="h-1 bg-emerald-500 w-0" role="progressbar" aria-label="model download progress"></div>

  <header class="py-4 text-center">
    <h1 class="text-3xl font-bold tracking-tight">Shroomtop420™ Chatbot</h1>
    <p class="text-slate-400">Runs 100 % in your browser – no keys, no servers.</p>
  </header>

  <main id="chat" class="flex-1 overflow-y-auto px-4 space-y-4"></main>

  <form id="inputForm" class="p-4 border-t border-slate-700">
    <label class="sr-only" for="prompt">Prompt</label>
    <input id="prompt" type="text" required
           class="w-full px-4 py-3 rounded-lg bg-slate-800 placeholder-slate-500 focus:outline-none"
           placeholder="Ask me anything…" autocomplete="off">
  </form>

  <!-- WebLLM + app logic -->
  <script type="module">
    import * as webllm from "https://esm.run/@mlc-ai/web-llm@0.2.79";

    const MODEL_ID = "TinyLlama-1.1B-Chat-v1.0-q4f16_1-MLC";          // swap here to try lighter models
    const chatEl   = document.getElementById("chat");
    const form     = document.getElementById("inputForm");
    const promptIn = document.getElementById("prompt");
    const dlBar    = document.getElementById("dlBar");
    const msgs     = [];   // persistent chat transcript

    let engine;            // WebLLM engine instance

    /* ---------- UI helpers ---------- */
    const escape = s => s.replace(/[&<>"']/g,c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]));

    function render() {
      chatEl.innerHTML = msgs.map(m =>
        `<div class="flex ${m.role==='user'?'justify-end':''}">
           <div class="px-4 py-2 rounded-lg max-w-prose whitespace-pre-line
               ${m.role==='user'?'bg-blue-600':'bg-slate-700'}">${escape(m.content)}</div>
         </div>`
      ).join("");
      chatEl.scrollTop = chatEl.scrollHeight;
    }

    async function streamReply() {
      const reply = { role:"assistant", content:"" };
      msgs.push(reply); render();

      const stream = await engine.chat.completions.create({
        messages: msgs,
        stream:   true
      });

      for await (const {choices:[{delta:{content=''}}]} of stream) {
        reply.content += content;
        render();
      }
    }

    /* ---------- Initialise engine ---------- */
    (async () => {
      promptIn.disabled = true;
      promptIn.placeholder = "Downloading model… first load may take a few minutes.";

      engine = new webllm.Engine();

      /* live download % + bar */
      engine.setInitProgressCallback(({progress,total})=>{
        const pct = total ? Math.round(progress/total*100) : 0;
        promptIn.placeholder = `Downloading… ${pct} %`;
        dlBar.style.width = pct + "%";
      });

      try {
        await engine.init(MODEL_ID);
      } catch (e) {
        promptIn.placeholder = "❌ Model failed. Check console.";
        console.error(e);
        return;
      }

      /* ready */
      dlBar.classList.add("opacity-0");                 // hide bar
      promptIn.placeholder = "Ask me anything…";
      promptIn.disabled = false;
      promptIn.focus();
    })();

    /* ---------- User submits ---------- */
    form.addEventListener("submit", async e => {
      e.preventDefault();
      const text = promptIn.value.trim();
      if (!text) return;
      msgs.push({ role:"user", content:text });
      promptIn.value = ""; render();
      try { await streamReply(); }
      catch (err) {
        msgs.push({ role:"assistant", content:`⚠️ Error: ${err.message}` });
        render();
      }
    });
  </script>
</body>
</html>
