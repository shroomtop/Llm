<!DOCTYPE html>
<html lang="en" data-theme="dark">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Shroomtop420™ No-API Chatbot</title>

  <!-- CSP / hardening -->
  <meta http-equiv="Content-Security-Policy"
        content="default-src 'self' https://cdn.jsdelivr.net https://esm.run;
                 style-src  'self' https://cdn.jsdelivr.net 'unsafe-inline';
                 script-src 'self' https://cdn.jsdelivr.net https://esm.run 'unsafe-inline';
                 img-src 'self' data:;
                 connect-src *;
                 upgrade-insecure-requests;">

  <!-- Tailwind Play CDN -->
  <script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"></script>

  <style>
    /* Bottom progress bar */
    #dlBarWrap {
      position: fixed;
      left: 0; right: 0; bottom: 0;
      z-index: 50;
      background: rgba(30,41,59,0.95); /* slate-800, nearly opaque */
      pointer-events: none;
      transition: opacity .4s;
    }
    #dlBar {
      height: 6px;
      background: linear-gradient(90deg,#22d3ee,#10b981);
      width: 0;
      transition: width .15s;
      border-radius: 0 0 6px 6px;
    }
    #dlBarText {
      text-align: center;
      font-size: 0.92rem;
      color: #94a3b8;
      margin: 0.3em 0 0.15em 0;
      font-family: ui-monospace,monospace;
      letter-spacing: 0.03em;
    }
    #dlBarWrap.hide { opacity:0; }
  </style>
</head>
<body class="min-h-screen flex flex-col bg-slate-900 text-slate-100 antialiased">

  <!-- BOTTOM PROGRESS BAR -->
  <div id="dlBarWrap">
    <div id="dlBar"></div>
    <div id="dlBarText">Downloading model…</div>
  </div>

  <header class="py-4 text-center">
    <h1 class="text-3xl font-bold tracking-tight">Shroomtop420™ Chatbot</h1>
    <p class="text-slate-400">Runs 100 % in your browser – no keys, no servers.</p>
  </header>

  <main id="chat" class="flex-1 overflow-y-auto px-4 space-y-4"></main>

  <form id="inputForm" class="p-4 border-t border-slate-700">
    <label class="sr-only" for="prompt">Prompt</label>
    <input id="prompt" type="text" required
           class="w-full px-4 py-3 rounded-lg bg-slate-800 placeholder-slate-500 focus:outline-none"
           placeholder="Ask me anything…" autocomplete="off">
  </form>

  <!-- WebLLM + app logic -->
  <script type="module">
    import * as webllm from "https://esm.run/@mlc-ai/web-llm@0.2.79";
    const MODEL_ID = "TinyLlama-1.1B-Chat-v1.0-q4f16_1-MLC";
    const chatEl   = document.getElementById("chat");
    const form     = document.getElementById("inputForm");
    const promptIn = document.getElementById("prompt");
    const dlBarWrap= document.getElementById("dlBarWrap");
    const dlBar    = document.getElementById("dlBar");
    const dlBarTxt = document.getElementById("dlBarText");
    const msgs     = [];

    let engine;

    // HTML escape (security best-practice)
    const escape = s => s.replace(/[&<>"']/g,c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]);

    function render() {
      chatEl.innerHTML = msgs.map(m =>
        `<div class="flex ${m.role==='user'?'justify-end':''}">
           <div class="px-4 py-2 rounded-lg max-w-prose whitespace-pre-line
               ${m.role==='user'?'bg-blue-600':'bg-slate-700'}">${escape(m.content)}</div>
         </div>`
      ).join("");
      chatEl.scrollTop = chatEl.scrollHeight;
    }

    async function streamReply() {
      const reply = { role:"assistant", content:"" };
      msgs.push(reply); render();
      const stream = await engine.chat.completions.create({
        messages: msgs, stream: true
      });
      for await (const {choices:[{delta:{content=''}}]} of stream) {
        reply.content += content; render();
      }
    }

    // --- INITIALIZE: Model, Progress Bar, UI ---
    (async () => {
      promptIn.disabled = true;
      promptIn.placeholder = "Downloading model… first load may take a few minutes.";

      engine = new webllm.Engine();

      // Live download progress callback
      engine.setInitProgressCallback(({progress,total})=>{
        const pct = total ? Math.round(progress/total*100) : 0;
        dlBar.style.width = pct + "%";
        dlBarTxt.textContent = pct > 0
          ? `Downloading model… ${pct} %`
          : "Downloading model…";
      });

      try {
        await engine.init(MODEL_ID);
      } catch (e) {
        promptIn.placeholder = "❌ Model failed. Check console.";
        dlBarTxt.textContent = "❌ Download failed.";
        dlBar.style.background = "#ef4444";
        return;
      }

      // Model ready: hide bar, enable input
      setTimeout(()=>dlBarWrap.classList.add("hide"), 600);
      promptIn.placeholder = "Ask me anything…";
      promptIn.disabled = false;
      promptIn.focus();
    })();

    // --- Chat submit ---
    form.addEventListener("submit", async e => {
      e.preventDefault();
      const text = promptIn.value.trim();
      if (!text) return;
      msgs.push({ role:"user", content:text });
      promptIn.value = ""; render();
      try { await streamReply(); }
      catch (err) {
        msgs.push({ role:"assistant", content:`⚠️ Error: ${err.message}` });
        render();
      }
    });
  </script>
</body>
</html>
